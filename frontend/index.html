<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta property="og:url" content="https://oceanman2018.muehlemann.com/"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Visual Ranking: Oceanman Italia 2018"/>
    <meta property="og:author" content="Silvan Mühlemann"/>
    <meta property="og:description"
          content="This scatter chart show all participants of the Oceanman Italia 2018"/>
    <meta property="og:image" content="https://oceanman2018.muehlemann.com/og-image.png"/>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-10357230-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'UA-10357230-1');
    </script>


    <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <script src="//code.jquery.com/jquery-2.1.1.js"></script>
    <style>

        body {
            background-color: black;
            color: white;
            margin: 30px;
            font-family: 'Poppins', sans-serif;

        }

        div.margins {
            margin-left: 38px
        }

        h1 {
            margin-left: 38px;
        }

        .chart {
            margin: auto;
        }

        .chart circle {
            fill: #91c7ff;
            opacity: 0.5;
        }

        .chart circle.me {
            fill: red;
            opacity: 1
        }

        .chart circle.women {
            fill: #ffc0f5;
        }

        .chart text {
            fill: white;
            font: 12px sans-serif;
            /*text-anchor: ;*/
        }

        text.caption {
            display: none
        }

        text.caption.interesting {
            display: block;
        }

        .axis text {
            font: 10px sans-serif;
            fill: white;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: white;
            shape-rendering: crispEdges;
        }

    </style>
</head>
<body>
<h1 style="padding: 10px 16px">Visual Ranking: Oceanman Italia 2018</h1>
<div class="margins">
    <form role="form">
        <div class="form-inline">
            <p class="input-lg" style="height: auto">This scatter chart show all participants of the Oceanman Italia
                2018. The more
                they are on the left, the faster they are.
                The more on the top, the older. Type your name in the form field to find yourself. Touch the dots to see
                details.</p>

            <div class="form-group" style="margin-left: 20px">
                <div class="radio">
                    <label class=" input-lg">
                        <input type="radio" name="race" id="race-sprint" value="sprint" checked> Sprint
                    </label>
                    <label class=" input-lg">
                        <input type="radio" name="race" id="race-half" value="half" checked> Half
                    </label>
                    <label class=" input-lg">
                        <input type="radio" name="race" id="race-full" value="full" checked> Full
                    </label>
                </div>
            </div>


            <label class="control-label input-lg" for="participant">Search for name, team or nationality:</label>
            <input type="text" class="form-control input-lg" id="participant" size="30"
                   placeholder='"igor", "aquatic" or "mex"'>
            <div class="form-group" style="margin-left: 20px">
                <div class="checkbox">
                    <label class=" input-lg">
                        <input type="checkbox" class="gender" name="gender-male" id="gender-male" value="men" checked>
                        Men
                    </label>
                    <label class=" input-lg">
                        <input type="checkbox" class="gender" name="gender-female" id="gender-female" value="women"
                               checked>
                        Women
                    </label>
                </div>
            </div>
        </div>

    </form>
</div>
<div id="chart" style="width: 100%">
</div>
<div class="margins">&copy; <a href="https://mühlemann.ch">Silvan Mühlemann</a>, 24.6.2018, Data provided by <a
        href="https://www.endu.net/">endu.net</a></div>
<script src="//d3js.org/d3.v3.min.js"></script>
<script type="text/javascript">

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }


    var chartDiv = document.getElementById("chart");
    var svg = d3.select(chartDiv).append("svg");

    var width = chartDiv.clientWidth;
    var height = chartDiv.clientWidth / 2.5;

    var margin = {'left': 40, 'right': 80, 'top': 20, 'bottom': 10};

    var x = d3.time.scale()
        .range([margin.left, width - margin.right - margin.left]);

    var y = d3.scale.linear()
        .range([height - margin.top - margin.bottom, margin.top]);

    var xAxis = d3.svg.axis()
        .scale(x)
        .orient('bottom')
        .tickFormat(d3.time.format('%H:%M'));

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient('left');

    var chart = svg
        .attr("width", width)
        .attr("height", height)
        .attr("class", 'chart')
        .append("g")
        .attr("transform", "translate(" + (margin.left) + ", " + margin.top + ")");

    $("input.gender").click(function () {
        var gender = $(this).val();
        if ($(this).prop('checked')) {
            $('circle.' + gender).show();
        } else {
            $('circle.' + gender).hide();
        }
    });

    $("#participant").keyup(function () {
        if ($("#participant").val().length >= 3) {
            jQuery.each(jQuery("circle"), function (ix, e) {
                attr = e.getAttribute('class');

                if (e.getAttribute('data-name').toLowerCase().indexOf($("#participant").val().toLowerCase()) >= 0) {
                    e.setAttribute('class', 'me');
                    $(this).parent().find('text').show();
                } else {
                    e.setAttribute('class', e.getAttribute('data-gender'));
                    $(this).parent().find('text').hide();
                }
            });
        }
    });


    function redraw() {

        var race = race = $('input[name=race]:checked').val();

        var isInteresting = function (d) {

            if (getParameterByName('bib') > 0 && d.Bib==getParameterByName('bib')) {
                return true;
            }

            if (race == 'full') {
                return ["277", "1"].indexOf(d.Bib) >= 0;
            } else if (race == 'half') {
                return ["478", "451"].indexOf(d.Bib) >= 0;
            } else {
                return ["137", "132"].indexOf(d.Bib) >= 0;
            }
            //return false
        };


        //dsv("cityrun-male.csv", type, function (error, data) {
        //dsv("silvesterlauf.csv", type, function (error, data) {
        d3.json("processed-" + race + ".json", function (error, data) {

            d3.selectAll("g.elems").remove();
            d3.selectAll(".axis").remove();

            data = convertType(data);
            x.domain([
                d3.min(data, function (d) {
                    return d.OffsetTime;
                }),
                d3.max(data, function (d) {
                    return d.OffsetTime;
                })]);

            y.domain(d3.extent(data, function (d) {
                return d.Age;
            }));

            // Move the interesting values to the front (z-index in SVG)
            var interestingValues = data.filter(isInteresting);
            var uninterestingValues = data.filter(function (d) {
                return !isInteresting(d);
            });
            data = d3.merge([uninterestingValues, interestingValues]);

            dot = chart.selectAll("g")
                .data(data)
                .enter().append("g")
                .attr("class", "elems")
                .attr("transform", function (d, i) {
                    return "translate(" + x(d.OffsetTime) + "," + y(d.Age) + ")";
                });

            dot.append('circle')
                .attr('cy', 0)
                .attr('cx', 0)
                .attr("r", "0.6rem")
                .attr("class", function (d) {
                    if (isInteresting(d)) {
                        return "me";
                    }
                    if (d.Gender == 'F') {
                        return "women";
                    } else {
                        return "men";
                    }
                })
                .attr('data-name', function (d) {
                    return d.Name + ", " + d.Cat;
                })
                .attr('data-time', function (d) {
                    return d.OffsetTime;
                })
                .attr('data-gender', function (d) {
                    if (d.Gender == 'F') {
                        return "women";
                    } else {
                        return "men";
                    }
                })
                .attr('data-age', function (d) {
                    return d.Age;
                });

            dot.append("text", "circle")
                .attr('class', function (d) {
                    return 'caption' + (isInteresting(d) ? ' interesting' : '');
                })
                .attr("y", 0)
                .attr("x", 5)
                .attr("dy", ".35em")
                .text(function (d) {
                    return d.Rank + ". " + d.Name + ", " + d.Time;
                });

            chart.append("g")
                .attr("class", "x axis")
                .call(xAxis)
                .append("text")
                .attr("x", (width - margin.left - margin.right) / 2 + margin.left)
                .attr("y", -15)
                .attr("dy", ".71em")
                .style("text-anchor", "center")
                .text("Finish time");

            chart.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("x", -margin.top + (+margin.bottom + margin.top - height) / 2)
                .attr("dy", ".71em")
                .style("text-anchor", "begin")
                .text("Age");

            jQuery("circle").click(function () {
                console.log($(this).data().name + " " + $(this).data().age);
            });

            jQuery("circle:not(.interesting)").hover(function () {
                $(this).parent().find('text').fadeIn();
            }, function () {
                $(this).parent().find('text').fadeOut();
            });

            /*$("text.caption").click(function() {
         $(this).show();
         })*/
        });

        function convertType(d) {
            for (i = 0; i < d.length; i++) {
                var hms = d[i].Time;   // your input string
                var a = hms.split(':'); // split it at the colons

                if (a.length == 2) {
                    var date = new Date(0, 0, 0, 0, +a[0], +a[1]);
                } else {
                    var date = new Date(0, 0, 0, +a[0], +a[1], +a[2]);
                }
                d[i].OffsetTime = date;
            }

            return d.reverse();
        }
    }

    $('input[name=race]').on('click', function () {
        var race = $('input[name=race]:checked').val();
        console.log(race);
        redraw();
    });

    // Draw for the first time to initialize.
    redraw();


</script>
</body>
</html>